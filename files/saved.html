<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Saved Rankings ‚Ä¢ Pok√©Rankr</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="style.css" />
  <style>
    /* --- Page-specific UI tweaks --- */
    .saved-toolbar{
      display:flex;justify-content:space-between;align-items:center;
      gap:10px;margin:10px 0 12px;
      flex-wrap:wrap;
    }
    .mini-btn{
      appearance:none;border:none;cursor:pointer;
      background:#fff;border:2px solid #cfd9ff;color:#2f5fe0;
      border-radius:10px;padding:8px 10px;font-weight:700;
    }
    .mini-btn:hover{background:#f5f7ff}
    .danger{color:#a11;border-color:#f0caca}
    .danger:hover{background:#fff1f1}

    .filters{ display:flex; gap:8px; align-items:center; flex-wrap:wrap }
    .filters input[type="search"]{
      border:2px solid #cfd9ff; border-radius:10px; padding:8px 10px; width:260px;
      font-weight:600; outline:none;
    }
    .filters select{
      border:2px solid #cfd9ff; border-radius:10px; padding:8px 10px; font-weight:700; outline:none;
    }

    /* ===== Saved Rankings horizontal bars ===== */
    .saved-row{ padding:12px 14px; text-align:left; }
    .saved-row-header{
      display:flex; justify-content:space-between; align-items:center;
      margin-bottom:8px; gap:10px; flex-wrap:wrap;
    }
    .saved-row-slots{
      display:flex; align-items:stretch; justify-content:space-between;
      gap:10px;
    }

    /* Ultra-tight slots with 100x100 sprites */
    .saved-slot{
      position:relative;
      flex:1;
      display:flex;
      align-items:center;
      gap:8px;
      border:2px solid #dfe7ff;
      border-radius:12px;
      background:var(--panel-soft);
      height:110px;
      padding:4px 8px 4px 8px;
    }
    .saved-slot.empty{ opacity:.6 }

    .saved-label{
      position:absolute;
      top:4px; left:8px;
      font-size:.75rem;
      font-weight:700;
      color:var(--accent);
      line-height:1;
      pointer-events:none;
    }

    .saved-core{
      display:flex;
      align-items:center;
      gap:8px;
      width:100%;
      margin-top:12px;
    }

/* Saved Rankings: preview sprite */
.saved-sprite{
  width: 90px;
  height: 90px;
  object-fit: contain;
  image-rendering: pixelated;
  flex-shrink: 0;
}

/* Slightly shrink G-Max / Eternamax */
.saved-sprite.is-gmax{
  transform: scale(1);
  transform-origin: center;
}

/* (Optional: works via the data attribute too) */
.saved-sprite[data-variety$="-gmax"],
.saved-sprite[data-variety$="-eternamax"]{
  transform: scale(1);
}



    .saved-text{ line-height:1.1; flex:1; }
    .saved-name{ font-weight:700; font-size:.9rem; }
    .saved-meta{ font-size:.75rem; color:var(--text-soft); }
    .text-soft{ color: var(--text-soft); }

    @media (max-width: 720px){
      .saved-row-slots{ flex-direction:column; }
      .filters input[type="search"]{ width:100%; }
    }
  </style>
  <!-- Supabase Client -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- User Header (shows when logged in) -->
<div id="userHeader" style="display:none; position:fixed; top:10px; right:10px; z-index:1000; background:rgba(255,255,255,0.95); backdrop-filter:blur(10px); border-radius:12px; padding:8px 12px; box-shadow:0 4px 12px rgba(0,0,0,0.1); border:2px solid #d2deff;">
  <div style="display:flex; align-items:center; gap:12px;">
    <img id="headerSprite" src="" alt="Trainer" style="width:32px; height:32px; image-rendering:pixelated;">
    <span id="headerUsername" style="font-weight:600; color:var(--text);"></span>
    <button id="btnLogout" class="compact" style="--button_color:#ff3b30; --button_outline_color:#ff3b30;">
      <span class="button_top" style="color:white; padding:0.3em 0.8em; font-size:12px;">Log Out</span>
    </button>
  </div>
</div>
  <div class="container">
    <h1>Saved Rankings</h1>

    <div class="saved-toolbar">
      <div class="filters">
        <input id="q" type="search" placeholder="Search Pok√©mon or category‚Ä¶" />
        <select id="mode">
          <option value="all">All modes</option>
          <option value="no">No Shinies</option>
          <option value="plus">+Shinies</option>
          <option value="only">Shiny‚Äëonly</option>
        </select>
        <select id="sort">
          <option value="dateDesc">Newest first</option>
          <option value="dateAsc">Oldest first</option>
          <option value="catAz">Category A‚ÜíZ</option>
        </select>
        <button class="mini-btn" id="btnClearFilters">Clear Search</button>
      </div>
      <div>
        <button class="mini-btn danger" id="btnClearAll">üßπ Delete All</button>
        <button class="mini-btn" onclick="window.location.href='index.html'">Back to Menu</button>
      </div>
    </div>

    <div id="saved-list"></div>
  </div>

  <script>
    const STORAGE_KEY = "savedRankings";

    /* ---------- Helpers ---------- */
    function pluralize(count, singular, plural) {
      return `${count} ${count === 1 ? singular : plural}`;
    }

 function sprite(mon) {
  const id    = (mon.formId || mon.id);
  const shiny = !!mon.shiny;
  const alt   = mon.name || "";
  const src   = shiny
    ? `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/shiny/${id}.png`
    : `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${id}.png`;

  const variety = mon.variety || ""; // e.g. "charizard-gmax" or "eternatus-eternamax"
  const isGmax  = /(?:-gmax$|-eternamax$)/i.test(variety);

  return `<img class="saved-sprite${isGmax ? ' is-gmax' : ''}"
               data-variety="${variety}"
               src="${src}" alt="${alt}">`;
}




    function slot(label, mon) {
      if (!mon) {
        return `<div class="saved-slot empty"><span class="saved-label">${label}</span><span class="saved-meta" style="margin-left:8px;">‚Äî</span></div>`;
      }

      const survivedCount = mon.roundsSurvived || 0;
      const survivedLine = `<div class="saved-meta">Survived ${pluralize(survivedCount, "Round", "Rounds")}</div>`;

      // RU / Third: show "Won X Match/Matches" or "Auto-advanced".
      // Back-compat: only if save payload has bracketWins/bracketTotal.
      let extraLine = "";
      const isRU    = /runner/i.test(label);
      const isThird = /third/i.test(label);
      if ((isRU || isThird) && typeof mon.bracketWins === "number") {
        const wins = mon.bracketWins;
        const total = (typeof mon.bracketTotal === "number") ? mon.bracketTotal : 0;
        if (wins > 0) {
          extraLine = `<div class="saved-meta">Won ${pluralize(wins, "Match", "Matches")}</div>`;
        } else {
          // If the bracket had zero matches (single-entrant), call it Auto-advanced; otherwise "Won 0 Matches".
          extraLine = `<div class="saved-meta">${total === 0 ? "Auto-advanced" : "Won 0 Matches"}</div>`;
        }
      } else {
        // Keep vertical alignment with an invisible placeholder line when we have nothing extra to show.
        extraLine = `<div class="saved-meta" style="visibility:hidden;">placeholder</div>`;
      }

      return `
        <div class="saved-slot">
          <span class="saved-label">${label}</span>
          <div class="saved-core">
            ${sprite(mon)}
            <div class="saved-text">
              <div class="saved-name">${mon.shiny ? "‚≠ê " : ""}${mon.name}</div>
              ${survivedLine}
              ${extraLine}
            </div>
          </div>
        </div>
      `;
    }

    function loadSaves() {
      try { return JSON.parse(localStorage.getItem(STORAGE_KEY) || "[]"); }
      catch { return []; }
    }
    function persistSaves(arr) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(arr));
    }

    function deleteEntry(key) {
      let saved = loadSaves();
      saved = saved.filter(run => {
        const runKey = run.key || run.id || `${(run.category||"")}_${!!run.includeShinies}_${!!run.shinyOnly}`;
        return runKey !== key;
      });
      persistSaves(saved);
      render();
    }

    function clearAll() {
      if (!confirm("Delete ALL saved rankings? This can‚Äôt be undone.")) return;
      persistSaves([]);
      render();
    }

   function formatMode(run) {
  // Use the full label if available (new saves), otherwise fall back to old format
  if (run.label) {
    return run.label;
  }
  
  // Fallback for older saves without dynamic labels
  const base = run.category || "Ranking";
  if (run.shinyOnly) return `${base} ‚Ä¢ Shiny‚Äëonly`;
  if (run.includeShinies) return `${base} ‚Ä¢ +Shinies`;
  return `${base} ‚Ä¢ No Shinies`;
}

    /* ---------- Search / Filter / Sort ---------- */
    const $q   = () => document.getElementById("q");
    const $mode= () => document.getElementById("mode");
    const $sort= () => document.getElementById("sort");

    function normalize(s){ return (s||"").toString().toLowerCase().trim(); }

    function matchesQuery(run, query){
      if (!query) return true;
      const hay = [
        run.category,
        run.champion?.name, run.runnerUp?.name, run.thirdPlace?.name, run.honorable?.name
      ].filter(Boolean).map(normalize).join(" ");
      return hay.includes(normalize(query));
    }

    function matchesMode(run, mode){
      if (mode === "all") return true;
      if (mode === "no")   return !run.includeShinies && !run.shinyOnly;
      if (mode === "plus") return  run.includeShinies && !run.shinyOnly;
      if (mode === "only") return  run.shinyOnly === true;
      return true;
    }

    function whenOf(run){
      // prefer lastModified; fallback to date
      return new Date(run.lastModified || run.date || Date.now()).getTime();
    }

    function sortRuns(arr, how){
      const copy = arr.slice();
      if (how === "dateAsc")  return copy.sort((a,b)=> whenOf(a) - whenOf(b));
      if (how === "catAz")    return copy.sort((a,b)=> (a.category||"").localeCompare(b.category||""));
      // default: newest first
      return copy.sort((a,b)=> whenOf(b) - whenOf(a));
    }

    function applyFilters(all){
      const q = $q().value;
      const mode = $mode().value;
      const sort = $sort().value;
      const filtered = all.filter(run => matchesQuery(run, q) && matchesMode(run, mode));
      return sortRuns(filtered, sort);
    }

    function debounce(fn, ms=200){
      let t; return (...args)=>{ clearTimeout(t); t=setTimeout(()=>fn(...args), ms); };
    }

    /* ---------- Render ---------- */
    function render() {
      const all = loadSaves();
      const saved = applyFilters(all);
      const list = document.getElementById("saved-list");

      if (saved.length === 0) {
        list.innerHTML = `<p class="panel panel-soft">No saved results${all.length ? " (try different filters)" : ""}.</p>`;
        return;
      }

      list.innerHTML = saved.map(run => {
        const whenStr = new Date(run.lastModified || run.date || Date.now()).toLocaleString();
        const key = run.key || run.id || `${(run.category||"")}_${!!run.includeShinies}_${!!run.shinyOnly}`;
        return `
          <div class="saved-row panel">
            <div class="saved-row-header">
              <div>
                <strong>${formatMode(run)}</strong>
                <span class="text-soft"> ‚Ä¢ ${whenStr}</span>
              </div>
              <button class="mini-btn danger" onclick="if(confirm('Delete this saved ranking?')) deleteEntry('${key.replace(/'/g,"\\'")}')">üóëÔ∏è Delete</button>
            </div>
            <div class="saved-row-slots">
              ${slot("üèÜ Champion", run.champion)}
              ${slot("Runner‚Äëup",   run.runnerUp)}
              ${slot("Third Place",       run.thirdPlace)}
              ${slot("Hon. Mention",run.honorable)}
            </div>
          </div>
        `;
      }).join("");
    }

    /* ---------- Events ---------- */
    document.getElementById("btnClearAll").addEventListener("click", clearAll);
    document.getElementById("btnClearFilters").addEventListener("click", () => {
      $q().value = ""; $mode().value = "all"; $sort().value = "dateDesc"; render();
    });
    $q().addEventListener("input", debounce(render, 120));
    $mode().addEventListener("change", render);
    $sort().addEventListener("change", render);

    render();
  </script>
  <script src="js/auth.js"></script>
<script>
// User Header Handler
(function() {
  const userHeader = document.getElementById('userHeader');
  const headerSprite = document.getElementById('headerSprite');
  const headerUsername = document.getElementById('headerUsername');
  const btnLogout = document.getElementById('btnLogout');
  
  async function updateUserHeader() {
    const user = window.PokeRankrAuth.getCurrentUser();
    
    if (!user) {
      userHeader.style.display = 'none';
      return;
    }
    
    const { data: profile } = await window.PokeRankrAuth.supabase
      .from('user_profiles')
      .select('username, sprite_id, sprite_shiny')
      .eq('user_id', user.id)
      .maybeSingle();
    
    if (profile) {
      const spriteUrl = profile.sprite_shiny
        ? `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/shiny/${profile.sprite_id}.png`
        : `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/${profile.sprite_id}.png`;
      
      headerSprite.src = spriteUrl;
      headerUsername.textContent = profile.username;
      userHeader.style.display = 'block';
    }
  }
  
  btnLogout?.addEventListener('click', async () => {
    if (confirm('Are you sure you want to log out?')) {
      await window.PokeRankrAuth.signOut();
      localStorage.removeItem('PR_PLAY_MODE');
      window.location.href = 'index.html';
    }
  });
  
  window.PokeRankrAuth.onAuthChange((user) => {
    updateUserHeader();
  });
  
  document.addEventListener('DOMContentLoaded', () => {
    setTimeout(updateUserHeader, 200);
  });
})();
</script>
</body>
</html>
