<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>PokéRankr</title>
  <link rel="stylesheet" href="style.css" />
</head>
<body>

  <!-- ====== LOADING PAGE ====== -->
  <div id="loading-page" class="page active">
    <div class="logo">PokéRankr Logo (TBD)</div>
    <div class="menu-buttons">
      <button id="btnStart" class="menu-button">Start</button>
      <!-- NEW: appears only if at least one slot is used -->
      <button id="btnManageSaves" class="menu-button" style="display:none;">Continue / Manage Saves</button>
      <button onclick="window.location.href='saved.html'">Saved Rankings</button>

      <button id="btnDownload" class="menu-button">Download Rankings</button>
      <input type="file" id="uploadInput" accept="application/json" style="display:none" />
      <button id="btnUpload" class="menu-button">Upload Rankings</button>
    </div>

    <!-- Manage Saves Modal -->
    <div id="manageSavesModal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.5); z-index:1000; align-items:center; justify-content:center;">
      <div style="background:#fff; padding:16px; border-radius:12px; width: min(720px, 94%);">
        <h3 style="margin-top:0;">Continue / Manage Saves</h3>
        <p>Pick a slot to resume or delete. Starters saves resume on the Starters page.</p>
        <div id="manageSlotsGrid" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:12px; margin:12px 0;">
          <!-- populated by JS -->
        </div>
        <div style="display:flex; gap:8px; justify-content:space-between; align-items:center;">
          <div>
            <button id="btnExportSaves" class="alt">Export Save Slots</button>
            <input type="file" id="importSavesInput" accept="application/json" style="display:none"/>
            <button id="btnImportSaves" class="alt">Import Save Slots</button>
          </div>
          <div>
            <button id="btnCloseManage">Close</button>
          </div>
        </div>
      </div>
    </div>

  </div> <!-- ✅ close loading-page -->

  <!-- ====== CONFIGURATION PAGE ====== -->
  <div id="config-page" class="page">
    <h1>Build Your Battle Pool</h1>

    <!-- Global Shiny Settings -->
    <div class="settings">
      <label>
        <input type="checkbox" id="include-shinies">
        Include Shinies
      </label>
      <label>
        <input type="checkbox" id="shiny-only">
        Shiny Only
      </label>
    </div>

    <!-- Category Selection -->
    <div class="config-section">
      <label for="category">Select Category:</label>
      <select id="category">
        <option value="">-- Choose --</option>
        <option value="generation">Generation</option>
        <option value="starters">Starters</option>
        <option value="legendaries">Legendaries</option>
        <option value="type">Type</option>
      </select>
    </div>

    <!-- Dynamic Options -->
    <div id="extra-options"></div>

    <div class="button-row">
      <button id="btnStartRanking">Start Ranking</button>
      <button id="btnBackToMenu" class="alt">Back</button>
    </div>
  </div>

  <script>
  /* =========================
     App/version constants
     ========================= */
  const APP_NAME = 'PokeRankr';
  const APP_VERSION = '1.0.0';
  const SCHEMA_VERSION = 1;

  const pageLoading = document.getElementById('loading-page');
  const pageConfig = document.getElementById('config-page');
  const categorySelect = document.getElementById('category');
  const extraOptions = document.getElementById('extra-options');

  const includeShiniesCheckbox = document.getElementById('include-shinies');
  const shinyOnlyCheckbox = document.getElementById('shiny-only');

  const TYPES = [
    "Normal","Fire","Water","Electric","Grass","Ice","Fighting","Poison",
    "Ground","Flying","Psychic","Bug","Rock","Ghost","Dragon","Dark","Steel","Fairy"
  ];

  // Make shiny checkboxes mutually exclusive
  includeShiniesCheckbox.addEventListener('change', () => {
    if (includeShiniesCheckbox.checked) shinyOnlyCheckbox.checked = false;
  });
  shinyOnlyCheckbox.addEventListener('change', () => {
    if (shinyOnlyCheckbox.checked) includeShiniesCheckbox.checked = false;
  });

  // Navigation
  document.getElementById('btnStart').addEventListener('click', () => {
    pageLoading.classList.remove('active');
    pageConfig.classList.add('active');

    categorySelect.value = '';
    extraOptions.innerHTML = '';

    document.body.classList.add('config-mode');
    window.scrollTo({ top: 0, behavior: 'instant' || 'auto' });
  });

  document.getElementById('btnBackToMenu').addEventListener('click', () => {
    pageConfig.classList.remove('active');
    pageLoading.classList.add('active');
    document.body.classList.remove('config-mode');
  });

  // Build dynamic extra options
  categorySelect.addEventListener('change', () => {
    const cat = categorySelect.value;
    extraOptions.innerHTML = '';

    if (cat === 'generation') {
  const supportedGens = [1, 2, 3, 4, 5, 6, 7, 8, 9];

  // Build Gen buttons + (hidden-by-default) toggles row
  extraOptions.innerHTML = `
    <div>
      <label>Select Generation:</label>
      <div class="category-buttons" id="genButtons" role="group" aria-label="Select Generation">
        ${supportedGens.map((g,i) => `
          <button
            type="button"
            class="menu-button gen-btn${i===0 ? ' selected' : ''}"
            data-gen="${g}"
            aria-pressed="${i===0 ? 'true' : 'false'}"
          >Gen ${g}</button>
        `).join('')}
      </div>
    </div>

    <!-- Per-gen toggles (shown/hidden by JS) -->
    <div class="settings" id="genToggleRow" style="display:none; margin-top:8px;">
      <label id="lblToggleRegional" style="display:none;">
        <input type="checkbox" id="toggle-regional" />
        Include Regional Forms (Alola/Galar/Hisui)
      </label>
      <label id="lblToggleAltBattle" style="display:none;">
        <input type="checkbox" id="toggle-altbattle" />
        Include Alternate/Battle Forms (e.g., Lycanroc)
      </label>
    </div>
  `;

  // Wire up gen selection
  const btns = extraOptions.querySelectorAll('.gen-btn');
  extraOptions.dataset.selectedGen = supportedGens[0];
  btns.forEach(btn => {
    btn.addEventListener('click', () => {
      btns.forEach(b => { b.classList.remove('selected'); b.setAttribute('aria-pressed','false'); });
      btn.classList.add('selected');
      btn.setAttribute('aria-pressed','true');
      extraOptions.dataset.selectedGen = btn.dataset.gen;

      // Re-evaluate which toggles should be visible for this gen
      updateGenTogglesVisibility();
    });
  });

  // Toggle visibility rules
  const REGIONAL_MIN_GEN = 7;             // Regional forms (Alola/Galar/Hisui) start showing at Gen 7+
  const ALT_BATTLE_GENS = new Set([7]);   // Only show Alt/Battle toggle for these gens (expand later if needed)

  const row           = extraOptions.querySelector('#genToggleRow');
  const chkRegional   = extraOptions.querySelector('#toggle-regional');
  const chkAltBattle  = extraOptions.querySelector('#toggle-altbattle');
  const lblRegional   = extraOptions.querySelector('#lblToggleRegional');
  const lblAltBattle  = extraOptions.querySelector('#lblToggleAltBattle');

  function updateGenTogglesVisibility() {
    const g = parseInt(extraOptions.dataset.selectedGen, 10);

    const showRegional  = g >= REGIONAL_MIN_GEN;
    const showAltBattle = ALT_BATTLE_GENS.has(g);

    lblRegional.style.display  = showRegional  ? '' : 'none';
    lblAltBattle.style.display = showAltBattle ? '' : 'none';

    // Show the row only if at least one toggle is relevant
    row.style.display = (showRegional || showAltBattle) ? '' : 'none';

    // Reset hidden toggles to unchecked
    if (!showRegional && chkRegional)   chkRegional.checked = false;
    if (!showAltBattle && chkAltBattle) chkAltBattle.checked = false;
  }

  // Initialize visibility for the default selected gen
  updateGenTogglesVisibility();
}

if (cat === 'legendaries') {
  extraOptions.innerHTML = `
    <div>
      <label>
        <input type="checkbox" id="include-mythicals">
        Include Mythicals
      </label>
    </div>
  `;
}

if (cat === 'type') {
  extraOptions.innerHTML = `
    <div>
      <label><input type="checkbox" id="chkMono" checked> Mono Type</label>
      <label><input type="checkbox" id="chkDual" checked> Dual Type</label>
    </div>
    <div>
      <label>Type 1:
        <select id="type1"></select>
      </label>
      <label id="type2Wrap">Type 2:
        <select id="type2"></select>
      </label>
    </div>
  `;

  const type1 = extraOptions.querySelector('#type1');
  const type2 = extraOptions.querySelector('#type2');
  [type1, type2].forEach(sel => {
    sel.innerHTML = `<option value="">Any</option>` + TYPES.map(t => `<option value="${t}">${t}</option>`).join('');
  });

  const chkMono = extraOptions.querySelector('#chkMono');
  const chkDual = extraOptions.querySelector('#chkDual');
  const type2Wrap = extraOptions.querySelector('#type2Wrap');

  function updateTypeUI() {
    if (!chkMono.checked && !chkDual.checked) chkMono.checked = true;
    type2Wrap.style.display = chkDual.checked ? 'inline-block' : 'none';
  }
  chkMono.addEventListener('change', updateTypeUI);
  chkDual.addEventListener('change', updateTypeUI);
  updateTypeUI();
}

  });

  // Helper for reading dynamic els
  function getEl(id){ return extraOptions.querySelector('#' + id); }

  // Start Ranking
  document.getElementById('btnStartRanking').addEventListener('click', () => {
    const category = categorySelect.value || 'starters';

    const config = {
      includeShinies: !!includeShiniesCheckbox.checked,
      shinyOnly: !!shinyOnlyCheckbox.checked,
      category,
      filters: {}
    };

   if (category === 'generation') {
  const gen = extraOptions.dataset.selectedGen;
  if (!gen) { alert('Choose a generation.'); return; }
  config.filters.generation = parseInt(gen, 10);

  // NEW: pass toggles along
  const chkRegional  = extraOptions.querySelector('#toggle-regional');
  const chkAltBattle = extraOptions.querySelector('#toggle-altbattle');
  config.toggles = {
    regional: !!(chkRegional && chkRegional.checked),
    altBattle: !!(chkAltBattle && chkAltBattle.checked),
  };
}


    if (category === 'starters') config.filters.starters = true;

    if (category === 'legendaries') {
      config.filters.legendaries = true;
      config.filters.includeMythicals = !!getEl('include-mythicals')?.checked;
    }

    if (category === 'type') {
      const mono = !!getEl('chkMono')?.checked;
      const dual = !!getEl('chkDual')?.checked;
      const t1 = getEl('type1')?.value || '';
      const t2 = getEl('type2')?.value || '';

      if (!mono && !dual) { alert('Pick Mono and/or Dual.'); return; }
      if (mono && !dual && !t1) { alert('Choose Type 1 for Mono.'); return; }
      if (!mono && dual && (!t1 || !t2)) { alert('Choose both Type 1 and Type 2 for Dual.'); return; }
      if (!mono && dual && t1 === t2) { alert('Type 1 and Type 2 must be different for Dual.'); return; }
      if (mono && dual && t2 && t1 === t2) { alert('If you pick Type 2, it must differ from Type 1.'); return; }

      config.filters.type = { mono, dual, type1: t1, type2: t2 };
    }

    localStorage.setItem('rankConfig', JSON.stringify(config));
    localStorage.setItem('includeShinies', config.includeShinies);
    localStorage.setItem('shinyOnly', config.shinyOnly);
    localStorage.setItem('category', config.category);

    const dest = (category === 'starters') ? 'starters.html' : 'ranker.html';
    window.location.href = dest;
  });

  /* =========================
     Storage helpers (v1)
     ========================= */

  function loadSavedArray(){
    try { return JSON.parse(localStorage.getItem('savedRankings') || '[]'); }
    catch { return []; }
  }
  function saveSavedArray(arr){
    localStorage.setItem('savedRankings', JSON.stringify(arr));
  }

  function canonicalKey(run){
    return run?.key || run?.id || `${(run?.category||'Unknown')}_${!!run?.includeShinies}_${!!run?.shinyOnly}`;
  }

  function parseWhen(run){
    const s = run?.lastModified || run?.date || new Date().toISOString();
    return new Date(s).getTime();
  }

  function collectAllRankingsFromLocal() {
    const map = {};
    const arr = loadSavedArray();
    for (const r of arr){
      if (!r) continue;
      const id = canonicalKey(r);
      map[id] = r;
    }
    return map;
  }

  function setAllRankingsToLocal(map) {
    const mergedArr = Object.values(map);
    saveSavedArray(mergedArr);
    localStorage.setItem('pokeRankr.rankings', JSON.stringify(map));
  }

  function buildExportPayload() {
    const arr = loadSavedArray();
    return {
      app: APP_NAME,
      appVersion: APP_VERSION,
      schemaVersion: SCHEMA_VERSION,
      exportedAt: new Date().toISOString(),
      rankings: arr
    };
  }

  function downloadRankings() {
    const data = buildExportPayload();
    if (!data.rankings.length) {
      alert('No saved rankings found to export.');
      return;
    }
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const ts = new Date().toISOString().replace(/[:.]/g, '-');
    const filename = `pokeRankr-backup-${ts}.json`;
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    document.body.appendChild(a);
    a.click();
    URL.revokeObjectURL(a.href);
    a.remove();
  }

  function isValidExport(obj) {
    return obj && typeof obj === 'object' &&
           obj.app === APP_NAME &&
           Array.isArray(obj.rankings);
  }

  // Merges imported rankings into existing using "Keep Newest" rule.
  function mergeKeepNewest(existingMap, importedArr){
    const out = { ...existingMap };
    for (const r of importedArr){
      if (!r || typeof r !== 'object') continue;
      const id = canonicalKey(r);
      const cur = out[id];
      if (!cur){
        out[id] = r;
        continue;
      }
      const curWhen = parseWhen(cur);
      const newWhen = parseWhen(r);
      if (newWhen > curWhen){
        out[id] = r;
      }
    }
    return out;
  }

  async function handleFileUpload(file) {
    try {
      const text = await file.text();
      const data = JSON.parse(text);

      if (!isValidExport(data)) {
        alert('Invalid file format. Please select a PokéRankr backup JSON.');
        return;
      }

      const existingMap = collectAllRankingsFromLocal();
      const merged = mergeKeepNewest(existingMap, data.rankings);
      setAllRankingsToLocal(merged);

      const before = Object.keys(existingMap).length;
      const after  = Object.keys(merged).length;
      const delta  = after - before;
      alert(`Import complete.\nUpdated or added ${Math.max(0, delta)} item(s) using "Keep Newest".`);

      if (after && confirm('Open Saved Rankings now?')) {
        window.location.href = 'saved.html';
      }
    } catch (err) {
      console.error(err);
      alert('Could not import that file.');
    }
  }

  // === Hook up Download / Upload buttons ===
  document.getElementById('btnDownload').addEventListener('click', downloadRankings);

  /* =========================
     Save Slots (global: 3)
     ========================= */
  const SAVE_SLOTS_KEY = 'PR_SAVE_SLOTS_V1';

  function slotsRead() {
    try {
      const arr = JSON.parse(localStorage.getItem(SAVE_SLOTS_KEY) || '[]');
      const out = Array.isArray(arr) ? arr.slice(0, 3) : [];
      while (out.length < 3) out.push(null);
      return out;
    } catch {
      return [null, null, null];
    }
  }
  function slotsWrite(slots) {
    localStorage.setItem(SAVE_SLOTS_KEY, JSON.stringify(slots));
  }
  function anySlotUsed() {
    return slotsRead().some(Boolean);
  }

  (function initManageSavesButton(){
    const btn = document.getElementById('btnManageSaves');
    if (!btn) return;
    if (anySlotUsed()) btn.style.display = '';
    btn.addEventListener('click', openManageSavesModal);
  })();

  function openManageSavesModal() {
    const m = document.getElementById('manageSavesModal');
    if (!m) return;
    m.style.display = 'flex';
    renderManageSlots();
  }
  function closeManageSavesModal() {
    const m = document.getElementById('manageSavesModal');
    if (!m) return;
    m.style.display = 'none';
  }
  document.getElementById('btnCloseManage')?.addEventListener('click', closeManageSavesModal);

  function spriteUrl(id, shiny) {
    return shiny
      ? `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/shiny/${id}.png`
      : `https://raw.githubusercontent.com/PokeAPI/sprites/master/sprites/pokemon/other/official-artwork/${id}.png`;
  }
  function renderManageSlots() {
    const grid = document.getElementById('manageSlotsGrid');
    const slots = slotsRead();

    grid.innerHTML = slots.map((slot, i) => {
      if (!slot) {
        return `
          <div class="slot-card" data-idx="${i}" style="border:1px solid #e5e7eb; border-radius:10px; padding:10px;">
            <div style="height:120px; display:flex; align-items:center; justify-content:center; color:#9ca3af;">Empty Slot</div>
            <div style="display:flex; gap:8px; margin-top:8px; justify-content:flex-end;">
              <button data-action="delete" data-idx="${i}" disabled>Delete</button>
              <button data-action="resume" data-idx="${i}" disabled>Resume</button>
            </div>
          </div>
        `;
      }

      const a = slot.currentMatchup?.a;
      const b = slot.currentMatchup?.b;
      const savedAt = new Date(slot.meta?.savedAt || Date.now()).toLocaleString();
      const title = slot.label || 'Saved Run';
      const hrefHint = slot.type === 'starters' ? 'starters.html' : 'ranker.html';

      const rem = (slot.progress && typeof slot.progress.remaining === 'number')
        ? slot.progress.remaining
        : (Array.isArray(slot.state?.remaining) ? slot.state.remaining.length : null);

      const remainingLine = (rem !== null && rem !== undefined)
        ? `<div style="font-size:.8rem; color:#374151; margin-top:4px; text-align:center;">${rem} matchups remaining</div>`
        : '';

      return `
        <div class="slot-card" data-idx="${i}" style="border:1px solid #e5e7eb; border-radius:10px; padding:10px;">
          <div style="display:flex; align-items:center; gap:8px; justify-content:center; height:120px;">
            ${a ? `<img src="${spriteUrl(a.id, a.shiny)}" alt="${a.name}" width="72" height="72">` : ''}
            <span style="font-weight:700;">VS</span>
            ${b ? `<img src="${spriteUrl(b.id, b.shiny)}" alt="${b.name}" width="72" height="72">` : ''}
          </div>
          <div style="font-size:.95rem; color:#111827; margin-top:4px; font-weight:600;">${title}</div>
          <div style="font-size:.8rem; color:#6b7280;">Saved ${savedAt}</div>
          ${remainingLine}
          <div style="display:flex; gap:8px; margin-top:8px; justify-content:flex-end;">
            <button data-action="delete" data-idx="${i}">Delete</button>
            <button data-action="resume" data-idx="${i}" data-href="${hrefHint}">Resume</button>
          </div>
        </div>
      `;
    }).join('');

    grid.onclick = (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const idx = +btn.dataset.idx;
      const action = btn.dataset.action;
      const slotsArr = slotsRead();

      if (action === 'delete') {
        if (slotsArr[idx] && !confirm('Delete this save slot?')) return;
        slotsArr[idx] = null;
        slotsWrite(slotsArr);
        renderManageSlots();
        if (!anySlotUsed()) document.getElementById('btnManageSaves').style.display = 'none';
        return;
      }

      if (action === 'resume') {
        const s = slotsArr[idx];
        if (!s) return;
        localStorage.setItem('PR_PENDING_RESUME_SLOT', String(idx));
        window.location.href = (s.type === 'starters') ? 'starters.html' : 'ranker.html';
      }
    };
  }

  function exportSaveSlots() {
    const data = {
      app: APP_NAME,
      appVersion: APP_VERSION,
      schemaVersion: SCHEMA_VERSION,
      exportedAt: new Date().toISOString(),
      saveSlots: slotsRead()
    };
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const ts = new Date().toISOString().replace(/[:.]/g, '-');
    const filename = `pokeRankr-saveSlots-${ts}.json`;
    const a = document.createElement('a');
    a.href = URL.createObjectURL(blob);
    a.download = filename;
    a.click();
    setTimeout(() => URL.revokeObjectURL(a.href), 1500);
  }
  function isValidSaveSlots(obj) {
    return obj && typeof obj === 'object' && obj.app === APP_NAME && Array.isArray(obj.saveSlots);
  }
  document.getElementById('btnExportSaves')?.addEventListener('click', exportSaveSlots);

  const importSavesInput = document.getElementById('importSavesInput');
  document.getElementById('btnImportSaves')?.addEventListener('click', () => importSavesInput.click());
  importSavesInput?.addEventListener('change', async (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    try {
      const text = await file.text();
      const data = JSON.parse(text);
      if (!isValidSaveSlots(data)) {
        alert('Invalid save-slots file.');
        importSavesInput.value = '';
        return;
      }
      slotsWrite((data.saveSlots || []).slice(0,3));
      renderManageSlots();
      document.getElementById('btnManageSaves').style.display = anySlotUsed() ? '' : 'none';
      alert('Save slots imported.');
    } catch (err) {
      console.error(err);
      alert('Could not import that file.');
    } finally {
      importSavesInput.value = '';
    }
  });

  const uploadInput = document.getElementById('uploadInput');
  document.getElementById('btnUpload').addEventListener('click', () => {
    uploadInput.click();
  });

  uploadInput.addEventListener('change', (e) => {
    const file = e.target.files?.[0];
    if (!file) return;
    handleFileUpload(file);
    uploadInput.value = '';
  });
  </script>
</body>
</html>
